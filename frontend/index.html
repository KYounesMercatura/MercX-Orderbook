<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OrderBook Demo</title>
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      
    }
    form, .orderbook, .trades {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
    }
    input, select, button {
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      border-radius: 8px;
      font-size: 1rem;
      border: none;
    }
    button {
      background: #3b82f6;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #2563eb;
    }
    h2 {
      margin-bottom: 10px;
      color: #93c5fd;
    }
    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #334155;
      padding: 8px;
      text-align: center;
    }
    .buy { color: #22c55e; }
    .sell { color: #ef4444; }
    #tradeResult {
      margin-top: 10px;
      background: #334155;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <main>
    <form id="tradeForm">
      <h2>Simulate Trade</h2>
      <input id="txid" placeholder="Txid (any text)">
      <input id="quantity" type="number" placeholder="Quantity">
      <input id="price" type="number" placeholder="Price">
      <input id="unitSize" type="number" placeholder="Unit Size">
      <select id="orderType">
        <option value="LMT">Limit (LMT)</option>
        <option value="FOK">Fill or Kill (FOK)</option>
        <option value="FAK">Fill and Kill (FAK)</option>
        <option value="MKT">Market (MKT)</option>
      </select>
      <button id="buyBtn">Buy</button>
      <button id="sellBtn">Sell</button>
      <div id="tradeResult"></div>
    </form>
    <section class="orderbook">
      <h2>📋 Open Orders</h2>
      <table>
        <thead>
          <tr><th>Txid</th><th>Side</th><th>Price</th><th>Quantity</th><th>Unit Size</th></tr>
        </thead>
        <tbody id="openOrdersTable">
          <!-- Open orders will appear here -->
        </tbody>
      </table>
    </section>
    
    <section class="orderbook">
      <h2>📈 Live OrderBook (Level 1)</h2>
      <table>
        <thead>
          <tr><th>Side</th><th>Price</th><th>Quantity</th></tr>
        </thead>
        <tbody id="level1Table">
          <!-- Best Bid/Ask -->
        </tbody>
      </table>
    </section>

    <section class="orderbook">
      <h2>📊 OrderBook Depth</h2>
      <table>
        <thead>
          <tr><th>Side</th><th>Price</th><th>Quantity</th></tr>
        </thead>
        <tbody id="depthTable">
          <!-- Full Depth -->
        </tbody>
      </table>
    </section>

    <section class="trades">
      <h2>🕒 Recent Trades</h2>
      <ul id="tradeHistory">
        <!-- Recent Trades -->
      </ul>
    </section>
  </main>

<script type="module">
  import { backend } from 'declarations/backend';

  async function refreshLevel1() {
    try {
      const res = await backend.level1();
      const table = document.getElementById('level1Table');
      table.innerHTML = '';

      if (res.bid) {
        table.innerHTML += `
          <tr class="buy">
            <td>Buy</td>
            <td>${res.bid.price}</td>
            <td>${res.bid.quantity}</td>
          </tr>`;
      }
      if (res.ask) {
        table.innerHTML += `
          <tr class="sell">
            <td>Sell</td>
            <td>${res.ask.price}</td>
            <td>${res.ask.quantity}</td>
          </tr>`;
      }
    } catch (err) {
      console.error("Level1 fetch failed:", err);
    }
  }

  async function refreshDepth() {
  try {
    const res = await backend.depth([]);

    const table = document.getElementById('depthTable');
    table.innerHTML = '';

    if (res?.buy && Array.isArray(res.buy)) {
      res.buy.forEach(bid => {
        table.innerHTML += `
          <tr class="buy">
            <td>Buy</td>
            <td>${bid.price}</td>
            <td>${bid.quantity}</td>
          </tr>
        `;
      });
    }

    if (res?.sell && Array.isArray(res.sell)) {
      res.sell.forEach(ask => {
        table.innerHTML += `
          <tr class="sell">
            <td>Sell</td>
            <td>${ask.price}</td>
            <td>${ask.quantity}</td>
          </tr>
        `;
      });
    }
  } catch (err) {
    console.error("Depth fetch failed:", err);
  }
}


  async function handleTrade(side) {
    const txidText = document.getElementById('txid').value.trim();
    const quantity = Number(document.getElementById('quantity').value);
    const price = Number(document.getElementById('price').value);
    const unitSize = Number(document.getElementById('unitSize').value);
    const orderTypeText = document.getElementById('orderType').value;

    if (!txidText || quantity <= 0 || price <= 0 || unitSize <= 0) {
      document.getElementById('tradeResult').innerText = "⚠️ Please fill all fields.";
      return;
    }

    const txid = Array.from(new TextEncoder().encode(txidText));
    const sideVariant = { [side]: null };
    const orderTypeVariant = { [orderTypeText]: null };

    try {
      const result = await backend.trade(txid, sideVariant, quantity, price, orderTypeVariant, unitSize);
      document.getElementById('tradeResult').innerText = "✅ Trade successful!";
      addTradeToHistory(side, quantity, price);
      await refreshLevel1();
      await refreshDepth();
    } catch (err) {
      document.getElementById('tradeResult').innerText = "❌ Error: " + err.message;
    }
  }

  function addTradeToHistory(side, quantity, price) {
    const history = document.getElementById('tradeHistory');
    const li = document.createElement('li');
    li.className = side.toLowerCase();
    li.textContent = `${side} ${quantity} @ ${price}`;
    history.prepend(li);
    if (history.children.length > 10) {
      history.removeChild(history.lastChild);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('buyBtn').addEventListener('click', (e) => {
      e.preventDefault();
      handleTrade('Buy');
    });
    document.getElementById('sellBtn').addEventListener('click', (e) => {
      e.preventDefault();
      handleTrade('Sell');
    });

    // Initial Load
    refreshLevel1();
    refreshDepth();
    refreshOpenOrders();
    setInterval(() => {
      refreshLevel1();
      refreshDepth();
      refreshOpenOrders();
    }, 5000); // Auto refresh every 5 seconds
  });
  async function refreshOpenOrders() {
  try {
    const res = await backend.getOpenOrders(); // <-- You must have a function for this in backend
    const table = document.getElementById('openOrdersTable');
    table.innerHTML = '';

    res.forEach(order => {
      const side = order.side.hasOwnProperty('Buy') ? 'Buy' : 'Sell';
      table.innerHTML += `
        <tr class="${side.toLowerCase()}">
          <td>${new TextDecoder().decode(new Uint8Array(order.txid))}</td>
          <td>${side}</td>
          <td>${order.price}</td>
          <td>${order.quantity}</td>
          <td>${order.unit_size}</td>
        </tr>
      `;
    });
  } catch (err) {
    console.error("Open Orders fetch failed:", err);
  }
}

</script>

</body>
</html>
